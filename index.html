<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoodYum Supermarket</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@7.24.8/babel.min.js"></script>
    <style>
        /* Compiled Tailwind CSS styles */
        .bg-gray-100 { background-color: #f3f4f6; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .min-h-screen { min-height: 100vh; }
        .w-full { width: 100%; }
        .max-w-4xl { max-width: 1024px; }
        .p-6 { padding: 1.5rem; }
        .bg-white { background-color: #ffffff; }
        .p-8 { padding: 2rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .text-center { text-align: center; }
        .text-2xl { font-size: 1.5rem; }
        .font-bold { font-weight: 700; }
        .mb-6 { margin-bottom: 1.5rem; }
        .fade-in { opacity: 0; animation: fadeIn 1s forwards; }
        @keyframes fadeIn { to { opacity: 1; } }
        .text-lg { font-size: 1.125rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mt-4 { margin-top: 1rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .bg-blue-500 { background-color: #3b82f6; }
        .text-white { color: #ffffff; }
        .rounded { border-radius: 0.25rem; }
        .hover\:bg-blue-600:hover { background-color: #2563eb; }
        .grid { display: grid; }
        .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
        .md\:grid-cols-5 { @media (min-width: 768px) { grid-template-columns: repeat(5, minmax(0, 1fr)); } }
        .gap-4 { gap: 1rem; }
        .product-card { transition: transform 0.2s; }
        .product-card:hover { transform: scale(1.05); }
        .bg-gray-50 { background-color: #f9fafb; }
        .cursor-pointer { cursor: pointer; }
        .selected { border: 2px solid #3b82f6; }
        .w-full { width: 100%; }
        .h-32 { height: 8rem; }
        .object-cover { object-fit: cover; }
        .mb-2 { margin-bottom: 0.5rem; }
        .font-semibold { font-weight: 600; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .block { display: block; }
        .disabled\:opacity-50:disabled { opacity: 0.5; }
        .space-x-4 { --tw-space-x-reverse: 0; margin-right: calc(1rem * var(--tw-space-x-reverse)); margin-left: calc(1rem * calc(1 - var(--tw-space-x-reverse))); }
        .flex-1 { flex: 1 1 0%; }
        .border { border-width: 1px; }
        .text-sm { font-size: 0.875rem; }
        .text-gray-500 { color: #6b7280; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-8 { margin-top: 2rem; }
        .text-xl { font-size: 1.25rem; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div id="root" class="w-full max-w-4xl p-6"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [stage, setStage] = useState('stimulus');
            const [selectedStimulus, setSelectedStimulus] = useState(null);
            const [stimulusDisplayed, setStimulusDisplayed] = useState(false);
            const [selectedProducts, setSelectedProducts] = useState([]);
            const [surveyResponses, setSurveyResponses] = useState({
                q1: [5, 5], q2: [5, 5], q3: [5, 5], q4: [5, 5], q5: [5, 5]
            });
            const [collectedData, setCollectedData] = useState({});
            const [participantId] = useState(Math.random().toString(36).substr(2, 9));
            const [completionCode] = useState(Math.random().toString(36).substr(2, 6).toUpperCase());

            const stimuli = [
                { id: 1, text: "Did you know? FoodYum Supermarkets now offers a rewards program that encourages environmentally-friendly shopping. For every plant-based or low-carbon item you add to your cart, you will receive one entry into a raffle for Amazon gift cards. The more eco-friendly choices you make, the more chances you have to win." },
                { id: 2, text: "Did you know? Many consumers report feeling guilty or ashamed after purchasing high-carbon-emission foods. At FoodYum Supermarkets, we encourage you to reflect on your decisions: Are you making environmentally responsible choices? Are you shopping like a good citizen?" },
                { id: 3, text: "Did you know? Environmentally-friendly shopping isn’t just about products—it reflects your personal commitment to society and the planet. If you agree with the value of environmentally-friendly living, please let your choices listen to your values. Your shopping behavior at FoodYum Supermarkets is an extension of your good citizenship." }
            ];

            const products = [
                { id: 1, name: "Pork Burgers", price: 10, image: "https://via.placeholder.com/150/FFFFFF/000000?text=Pork+Burgers" },
                { id: 2, name: "Bread", price: 10, image: "https://via.placeholder.com/150/FFFFFF/000000?text=Bread" },
                { id: 3, name: "Fried Chicken", price: 10, image: "https://via.placeholder.com/150/FFFFFF/000000?text=Fried+Chicken" },
                { id: 4, name: "Sausage Pizza", price: 10, image: "https://via.placeholder.com/150/FFFFFF/000000?text=Sausage+Pizza" },
                { id: 5, name: "Fried Beef", price: 10, image: "https://via.placeholder.com/150/FFFFFF/000000?text=Fried+Beef" },
                { id: 6, name: "Vegan Salad", price: 10, image: "https://via.placeholder.com/150/FFFFFF/000000?text=Vegan+Salad" },
                { id: 7, name: "Veggie Burger", price: 10, image: "https://via.placeholder.com/150/FFFFFF/000000?text=Veggie+Burger" },
                { id: 8, name: "Mock Meat", price: 10, image: "https://via.placeholder.com/150/FFFFFF/000000?text=Mock+Meat" },
                { id: 9, name: "Apple Pie", price: 10, image: "https://via.placeholder.com/150/FFFFFF/000000?text=Apple+Pie" },
                { id: 10, name: "Ham Sandwich", price: 10, image: "https://via.placeholder.com/150/FFFFFF/000000?text=Ham+Sandwich" }
            ];

            const questions = [
                { id: 'q1', text: "In any community I might live in: It would be more important for me to", options: ["Get from the community", "Give to the community"] },
                { id: 'q2', text: "In any community I might live in: It would be more important for me to", options: ["Help others", "Watch out for my own good"] },
                { id: 'q3', text: "In any community I might live in: I would be more concerned about", options: ["What I received from the community", "What I contributed to the community"] },
                { id: 'q4', text: "In any community I might live in: The hard work I would do should", options: ["Benefit the community", "Benefit me"] },
                { id: 'q5', text: "In any community I might live in: My personal philosophy in dealing with the community would be", options: ["If I don’t look out for myself, nobody else will", "It’s better for me to give than to receive"] }
            ];

            useEffect(() => {
                if (stage === 'stimulus' && !selectedStimulus) {
                    const randomIndex = Math.floor(Math.random() * stimuli.length);
                    setSelectedStimulus(stimuli[randomIndex]);
                }
                if (stage === 'stimulus' && selectedStimulus && !stimulusDisplayed) {
                    const timer = setTimeout(() => {
                        setStimulusDisplayed(true);
                    }, 5000);
                    return () => clearTimeout(timer);
                }
            }, [selectedStimulus, stimulusDisplayed, stage]);

            const handleProductSelect = (productId) => {
                if (selectedProducts.includes(productId)) {
                    setSelectedProducts(selectedProducts.filter(id => id !== productId));
                } else if (selectedProducts.length < 8) {
                    setSelectedProducts([...selectedProducts, productId]);
                } else {
                    alert("最多只能選擇 8 種商品！");
                }
            };

            const handleSurveyChange = (questionId, optionIndex, value) => {
                const newResponses = { ...surveyResponses };
                const otherIndex = optionIndex === 0 ? 1 : 0;
                const newValue = Math.max(0, Math.min(10, parseInt(value) || 0));
                const otherValue = 10 - newValue;
                newResponses[questionId][optionIndex] = newValue;
                newResponses[questionId][otherIndex] = otherValue;
                setSurveyResponses(newResponses);
            };

            const handleSubmit = () => {
                const data = {
                    participantId: participantId,
                    stimulus: selectedStimulus ? `Stimulus ${selectedStimulus.id}` : '',
                    selectedProducts: selectedProducts.map(id => products.find(p => p.id === id).name),
                    surveyResponses: surveyResponses
                };
                setCollectedData(data);
                console.log("實驗數據：", data);

                // 生成 CSV
                const csvRows = [
                    ["Participant ID", "Stimulus", "Selected Products", ...questions.map(q => q.options[0]), ...questions.map(q => q.options[1])],
                    [
                        participantId,
                        data.stimulus,
                        `"${data.selectedProducts.join(", ")}"`,
                        ...questions.map(q => data.surveyResponses[q.id][0]),
                        ...questions.map(q => data.surveyResponses[q.id][1])
                    ]
                ];
                const csvContent = csvRows.map(row => row.join(",")).join("\n");
                const blob = new Blob([csvContent], { type: "text/csv" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `participant_${participantId}.csv`;
                a.click();
                URL.revokeObjectURL(url);

                alert(`數據已提交！您的完成碼是：${completionCode}\n請記錄此代碼並返回 Prolific。CSV 文件已下載，同時請查看控制台以獲取詳細數據。`);
            };

            return (
                <div className="bg-white p-8 rounded-lg shadow-lg">
                    {stage === 'stimulus' && (
                        <div className="text-center">
                            <h1 className="text-2xl font-bold mb-6">FoodYum Supermarket 實驗</h1>
                            {selectedStimulus && (
                                <p className="fade-in text-lg mb-4" style={{ animationDelay: '0.5s' }}>
                                    {selectedStimulus.text}
                                </p>
                            )}
                            {stimulusDisplayed && (
                                <button
                                    className="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                                    onClick={() => setStage('shopping')}
                                >
                                    進入購物環節
                                </button>
                            )}
                        </div>
                    )}

                    {stage === 'shopping' && (
                        <div>
                            <h1 className="text-2xl font-bold mb-6 text-center">選擇商品（最多 8 種）</h1>
                            <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                                {products.map(product => (
                                    <div
                                        key={product.id}
                                        className={`product-card p-4 bg-gray-50 rounded-lg cursor-pointer text-center ${selectedProducts.includes(product.id) ? 'selected' : ''}`}
                                        onClick={() => handleProductSelect(product.id)}
                                    >
                                        <img src={product.image} alt={product.name} className="w-full h-32 object-cover mb-2 rounded" />
                                        <h3 className="font-semibold">{product.name}</h3>
                                        <p>${product.price}</p>
                                    </div>
                                ))}
                            </div>
                            <button
                                className="mt-6 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 mx-auto block"
                                onClick={() => setStage('survey')}
                                disabled={selectedProducts.length === 0}
                            >
                                進入問卷環節
                            </button>
                        </div>
                    )}

                    {stage === 'survey' && (
                        <div>
                            <h1 className="text-2xl font-bold mb-6 text-center">問卷調查</h1>
                            {questions.map((question, index) => (
                                <div key={question.id} className="mb-6">
                                    <h3 className="text-lg font-semibold mb-2">{question.text}</h3>
                                    <div className="flex space-x-4">
                                        {question.options.map((option, optIndex) => (
                                            <div key={optIndex} className="flex-1">
                                                <label className="block mb-1">{option}</label>
                                                <input
                                                    type="number"
                                                    min="0"
                                                    max="10"
                                                    value={surveyResponses[question.id][optIndex]}
                                                    onChange={(e) => handleSurveyChange(question.id, optIndex, e.target.value)}
                                                    className="w-full p-2 border rounded"
                                                />
                                            </div>
                                        ))}
                                    </div>
                                    <p className="text-sm text-gray-500 mt-1">
                                        總分：{surveyResponses[question.id][0] + surveyResponses[question.id][1]}/10
                                    </p>
                                </div>
                            ))}
                            <button
                                className="mt-6 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 mx-auto block"
                                onClick={handleSubmit}
                            >
                                提交
                            </button>
                        </div>
                    )}

                    {Object.keys(collectedData).length > 0 && (
                        <div className="mt-8 p-4 bg-gray-50 rounded">
                            <h2 className="text-xl font-bold mb-4">收集的數據</h2>
                            <pre className="text-sm">{JSON.stringify(collectedData, null, 2)}</pre>
                            <p className="text-lg mt-4">您的完成碼是：{completionCode}</p>
                            <p className="text-sm text-gray-500">請記錄此代碼並返回 Prolific。</p>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
